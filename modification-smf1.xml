<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<!-- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    This is an example modification file for SMF packages.

    ATTENTION: If you are trying to install this manually, you should try
    the package manager.  If it will not work for you, please take a look
    at the following for information on this format:
        http://mods.simplemachines.org/docs/manual-install.php

================================================================================

    Modification files can be used to modify files so that they do what
    your package needs them to do to work properly.

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -->

<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
    <!-- This information needs to be the same as that in the package-info.xml. -->
    <id>RRasco:SMFGarage</id>
    <version>0.6.0RC1</version>

    <file name="$boarddir/index.php">
        <operation>
            <search position="before"><![CDATA['findmember' => array('Subs-Auth.php', 'JSMembers'),]]></search>
            <add><![CDATA[
        'garage' => array('Garage.php', 'Garage'),
        'garagemanagement' => array('GarageManagement.php', 'GarageManagement'),
        'garagesettings' => array('GarageSettings.php', 'GarageSettings'),]]></add>
        </operation>
    </file>     

    <file name="$themedir/index.template.php">
        <operation>
            <search position="before"><![CDATA[global $context, $settings, $options, $scripturl, $txt, $modSettings]]></search>
            <add><![CDATA[, $smfgSettings]]></add>
        </operation>  
        
        <operation>
            <search position="before"><![CDATA[, 'viewmembers']]></search>
            <add><![CDATA[, 'garagesettings', 'garagemanagement']]></add>
        </operation>        
        
        <operation>
            <search position="before"><![CDATA[$current_action = 'search';]]></search>
            <add><![CDATA[
    if ($context['current_action'] == 'garage')
        $current_action = 'garage';]]></add>
        </operation>
        
        <operation>
            <search position="before"><![CDATA[function template_menu()
{
	global $context, $settings, $options, $scripturl, $txt]]></search>
            <add><![CDATA[, $smfgSettings]]></add>
        </operation>
        
        <operation>
            <search position="after"><![CDATA[// Work out where we currently are.]]></search>
            <add><![CDATA[// We need loadSmfgConfig()
	require_once('GarageFunctions.php');
	
	// Load settings
	loadSmfgConfig(); 

	]]></add>
        </operation>
        
        <operation>
            <search position="before"><![CDATA[</td>' , $current_action == 'home' ? '<td class="maintab_active_' . $last . '">&nbsp;</td>' : '';]]></search>
            <add><![CDATA[
            
    // Show the [garage] button.
    if(!$smfgSettings['disable_garage'] || allowedTo(array('manage_garage_settings', 'manage_garage'))) {
	    echo ($current_action=='garage' || $context['browser']['is_ie4']) ? '<td class="maintab_active_' . $first . '">&nbsp;</td>' : '' , '
	                <td valign="top" class="maintab_' , $current_action == 'garage' ? 'active_back' : 'back' , '">
	                    <a href="', $scripturl, '?action=garage">' , $txt['smfg_garage'] , '</a>
	                </td>' , $current_action == 'garage' ? '<td class="maintab_active_' . $last . '">&nbsp;</td>' : '';
    }]]></add>
        </operation>
        
        <operation>
            <search position="replace"><![CDATA[</head>
<body>';]]></search>
            <add><![CDATA[';
            
        // Define indices
        if(!isset($context['lightbox'])) $context['lightbox'] = 0;
        if(!isset($context['editinplace'])) $context['editinplace'] = 0;
        if(!isset($context['form_validation'])) $context['form_validation'] = 0;
        if(!isset($context['dynamicoptionlist'])) $context['dynamicoptionlist'] = 0;
        if(!isset($context['garage_js'])) $context['garage_js'] = 0;
        if(!isset($context['smfg_ajax'])) $context['smfg_ajax'] = 0;
        if(!isset($context['mootools'])) $context['mootools'] = 0;        
        if(!isset($context['garage_tips'])) $context['garage_tips'] = 0;
        
        if($context['mootools'] || isset($_REQUEST['sa']) && $_REQUEST['sa'] == 'forumProfile') {
            echo '
            <!-- MooTools Includes -->
            <script type="text/javascript" src="', $settings['default_theme_url'], '/mootools1.11.js"></script>
            ';
        }

        if($smfgSettings['enable_lightbox'] || isset($_REQUEST['sa']) && $_REQUEST['sa'] == 'forumProfile') {
            if($context['lightbox'] || isset($_REQUEST['sa']) && $_REQUEST['sa'] == 'forumProfile') {
            echo '
            <!-- Lightbox Includes -->
            <link rel="stylesheet" href="', $settings['default_theme_url'], '/shadowbox.css" type="text/css" media="screen" />
            <script type="text/javascript" src="', $settings['default_theme_url'], '/shadowbox-mootools.js"></script>  
            <script type="text/javascript" src="', $settings['default_theme_url'], '/shadowbox.js"></script> 
            <script type="text/javascript">
            window.addEvent("domready", function(){ Shadowbox.init() });
            </script>
            ';
            }
        }
        
        if($context['garage_js']) {        
            echo '
            <!-- Garage JavaScript Includes -->
            <script type="text/javascript" src="', $settings['default_theme_url'], '/garage_functions.js"></script>
            ';
        }
        
        if($context['form_validation']) {
            echo '
            <!-- Form Validation Includes -->
            <script language="JavaScript" src="', $settings['default_theme_url'], '/gen_validatorv2.js" type="text/javascript"></script>
            ';
        }
        
        if($context['dynamicoptionlist']) {
            echo '
            <!-- Dynamic Option List Includes -->
            <script language="javascript" type="text/javascript" src="', $settings['default_theme_url'], '/dynamicoptionlist.js"></script>
            ';
        }

        if($context['editinplace']) {
            echo '
            <script language="javascript" type="text/javascript" src="', $settings['default_theme_url'], '/smfg_eip.js"></script>
            ';
        }
        
        if($context['smfg_ajax']) {
            echo '
            <!-- AJAX For Image Regens -->
            <script language="javascript" type="text/javascript" src="', $settings['default_theme_url'], '/smfg_ajax.js"></script>
            ';
        }
        
        if($context['garage_tips']) {
            echo '
            <!-- Garage Tips -->
            <script language="javascript" type="text/javascript">
            window.addEvent(\'domready\', function() {
              var smfg_imageTitle = new Tips($$(\'.smfg_imageTitle\'));
              var smfg_videoTitle = new Tips($$(\'.smfg_videoTitle\'));
            });
            </script>
            <style type="text/css">
            .tool-tip {
                color: #fff;
                width: 139px;
                z-index: 13000;
            }
             
            .tool-title {
                font-weight: bold;
                font-size: 11px;
                margin: 0;
                color: #9FD4FF;
                padding: 8px 8px 4px;
                background: url(', $settings['default_theme_url'], '/images/bubble.png) top left;
            }
             
            .tool-text {
                font-size: 11px;
                padding: 4px 8px 8px;
                background: url(', $settings['default_theme_url'], '/images/bubble.png) bottom right;
            }
            </style>
            ';
        }
        
            echo '
            </head>
            <body>';
]]></add>
        </operation>
    </file>   

    <file name="$sourcedir/Admin.php">
        <operation>
            <search position="before"><![CDATA[isAllowedTo(array(]]></search>
            <add><![CDATA['manage_garage_settings', 'manage_garage', ]]></add>
        </operation>
    </file>       

    <file name="$sourcedir/Subs.php">
        <operation>
            <search position="before"><![CDATA[// Load the language and templates....]]></search>
            <add><![CDATA[
    loadLanguage('Garage');]]></add>
        </operation>
        
        <operation>
            <search position="before"><![CDATA[function constructPageIndex($base_url, &$start, $max_value, $num_per_page, $flexible_start = false]]></search>
            <add><![CDATA[, $type = "none"]]></add>
        </operation>
        
        <operation>
            <search position="replace"><![CDATA[$base_link = '<a class="navPages" href="' . ($flexible_start ? $base_url : strtr($base_url, array('%' => '%%')) . ';start=%d') . '">%s</a> ';]]></search>
            <add><![CDATA[if($type == "blog") {
        $typeStart = "blog_";
        $tabType = "#blog";
    } else if($type == "guestbook") {
        $typeStart = "gb_";
        $tabType = "#guestbook";
    } else {
        $typeStart = '';
        $tabType = '';
    }

	//$base_link = '<a class="navPages" href="' . ($flexible_start ? $base_url : strtr($base_url, array('%' => '%%')) . ';start=%d') . '">%s</a> ';
    $base_link = '<a class="navPages" href="' . ($flexible_start ? $base_url : strtr($base_url, array('%' => '%%')) . ';'.$typeStart.'start=%d'.$tabType) . '">%s</a> ';]]></add>
        </operation>
        
        <operation>
            <search position="after"><![CDATA[// Admin area 'Maintenance Controls'.]]></search>
            <add><![CDATA[
    // Admin area 'Garage'.
    if (allowedTo(array('manage_garage_settings', 'manage_garage')))
    {
        $context['admin_areas']['garage'] = array(
            'title' => $txt['smfg_garage'],
            'areas' => array()
        );
        
        if (allowedTo('manage_garage_settings'))
            $context['admin_areas']['garage']['areas']['garage_settings'] = '<a href="' . $scripturl . '?action=garagesettings">' . $txt['smfg_settings'] . '</a>';
            
        if (allowedTo('manage_garage'))
            $context['admin_areas']['garage']['areas']['garage_management'] = '<a href="' . $scripturl . '?action=garagemanagement">' . $txt['smfg_management'] . '</a>';
        
    }
    
]]></add>
        </operation>
        
        <operation>
            <search position="replace"><![CDATA[if (preg_match('~action(=|%3d)(?!dlattach)~i', $imgtag) != 0)
							$imgtag = preg_replace('~action(=|%3d)(?!dlattach)~i', 'action-', $imgtag);]]></search>
            <add><![CDATA[//if (preg_match('~action(=|%3d)(?!dlattach)~i', $imgtag) != 0)
                        if (preg_match('~action(=|%3d)(?!dlattach)(?!garage)~i', $imgtag) != 0)
                            //$imgtag = preg_replace('~action(=|%3d)(?!dlattach)~i', 'action-', $imgtag);
                            $imgtag = preg_replace('~action(=|%3d)(?!dlattach)(?!garage)~i', 'action-', $imgtag);]]></add>
        </operation>
        
        <operation>
            <search position="before"><![CDATA[$context['allow_admin'] = allowedTo(array(]]></search>
            <add><![CDATA['manage_garage_settings', 'manage_garage', ]]></add>
        </operation>
    </file>  
    
    <file name="$sourcedir/Subs-Post.php">        
        <operation>
            <search position="replace"><![CDATA[$message = preg_replace('~(\[img.*?\])(.+?)\[/img\]~eis', '\'$1\' . preg_replace(\'~action(=|%3d)(?!dlattach)~i\', \'action-\', \'$2\') . \'[/img]\'', $message);]]></search>
            <add><![CDATA[//$message = preg_replace('~(\[img.*?\])(.+?)\[/img\]~eis', '\'$1\' . preg_replace(\'~action(=|%3d)(?!dlattach)~i\', \'action-\', \'$2\') . \'[/img]\'', $message);
    $message = preg_replace('~(\[img.*?\])(.+?)\[/img\]~eis', '\'$1\' . preg_replace(\'~action(=|%3d)(?!dlattach)(?!garage)~i\', \'action-\', \'$2\') . \'[/img]\'', $message);]]></add>
        </operation>
    </file>  

    <file name="$sourcedir/ManagePermissions.php">
        <operation>
            <search position="before"><![CDATA['calendar' => array(
				'calendar_view' => false,
				'calendar_post' => false,
				'calendar_edit' => true,
			),]]></search>
            <add><![CDATA[
            'garage' => array(
                'view_garage' => false,
                'browse_vehicles' => false,
                'view_vehicles' => false,
                'own_vehicle' => false,
                'search_vehicles' => false,
                'browse_insurance' => false,
                'view_insurance' => false,
                'browse_shops' => false,
                'view_shops' => false,
                'browse_garages' => false,
                'view_garages' => false,
                'browse_qms' => false,
                'view_qms' => false,
                'browse_dynos' => false,
                'view_dynos' => false,
                'browse_laps' => false,
                'view_laps' => false,
                'post_comments' => false,
            ),
            'garage_acp' => array(
                'manage_garage_settings' => false,
                'manage_garage_general' => false,
                'manage_garage_menu' => false,
                'manage_garage_index' => false,
                'manage_garage_images' => false,
                'manage_garage_videos' => false,
                'manage_garage_modules' => false,
                'manage_garage' => false,
                'manage_garage_businesses' => false,
                'manage_garage_categories' => false,
                'manage_garage_makes_models' => false,
                'manage_garage_products' => false,
                'manage_garage_tools' => false,
                'manage_garage_tracks' => false,
                'manage_garage_other' => false,
                'manage_garage_pending' => false,
                'edit_all_vehicles' => false,
                'edit_all_comments' => false,
                'limit_exemption' => false,
                
            ),]]></add>
        </operation>
        
        <operation>
            <search position="before"><![CDATA['send_mail',]]></search>
            <add><![CDATA[
        'manage_garage_settings',
        'manage_garage_general',
        'manage_garage_menu',
        'manage_garage_index',
        'manage_garage_images',
        'manage_garage_videos',
        'manage_garage_modules',
        'manage_garage',
        'manage_garage_businesses',
        'manage_garage_categories',
        'manage_garage_makes_models',
        'manage_garage_products',
        'manage_garage_tools',
        'manage_garage_tracks',
        'manage_garage_other',
        'manage_garage_pending',
        'edit_all_vehicles',
        'edit_all_comments',
        'limit_exemption',
        'post_comments',
        'own_vehicle',]]></add>
        </operation>
        
        <operation>
            <search position="before"><![CDATA['post',]]></search>
            <add><![CDATA[
        'garage_acp',]]></add>
        </operation>
    </file>        

    <file name="$sourcedir/Security.php">
        <operation>
            <search position="before"><![CDATA[static $heavy_permissions = array(]]></search>
            <add><![CDATA[
        'manage_garage',
        'manage_garage_settings',]]></add>
        </operation>
    </file>

    <file name="$sourcedir/Profile.php">
        <operation>
            <search position="before"><![CDATA[updateMemberData($memID, $profile_vars);]]></search>
            <add><![CDATA[
            
        // Update garage notification options
        if(!isset($_POST['pm_opt_out'])) $_POST['pm_opt_out'] = "";
        if(!isset($_POST['email_opt_out'])) $_POST['email_opt_out'] = "";
        if(!isset($_POST['gb_opt_out'])) $_POST['gb_opt_out'] = "";
        
        if($_POST['pm_opt_out'] != '' && $_POST['email_opt_out'] != '') {
            $request = db_query("
                UPDATE {$db_prefix}garage_notifications
                SET pm_opt_out = ".$_POST['pm_opt_out'].", email_opt_out = ".$_POST['email_opt_out']."
                WHERE user_id = ".$memID,__FILE__,__LINE__);
		}
        
        if($_POST['gb_opt_out'] != '') {
            $request = db_query("
                SELECT id
                FROM {$db_prefix}garage_notifications_misc
                WHERE user_id = ".$memID,__FILE__,__LINE__);
            $numRows = mysql_num_rows($request);
            mysql_free_result($request);
            if($numRows == 0) {
                $request = db_query("
                    INSERT INTO {$db_prefix}garage_notifications_misc (user_id, gb_opt_out)
                    VALUES (".$memID.", ".$_POST['gb_opt_out'].")",__FILE__,__LINE__);
            } else {
                $request = db_query("
                    UPDATE {$db_prefix}garage_notifications_misc
                    SET gb_opt_out = ".$_POST['gb_opt_out']."
                    WHERE user_id = ".$memID,__FILE__,__LINE__);
            }
        }]]></add>
        </operation>
        
        <operation>
            <search position="after"><![CDATA[// How many rows can we expect?]]></search>
            <add><![CDATA[// Get Garage pending notification options
    $request = db_query("
        SELECT user_id, pm_opt_out, email_opt_out
        FROM {$db_prefix}garage_notifications
        WHERE user_id = ".$memID,__FILE__,__LINE__);
    list($context['memID'],
         $context['pm_opt_out'],
         $context['email_opt_out']) = mysql_fetch_row($request);
    mysql_free_result($request);
    
    // And misc notifications
    $request = db_query("
        SELECT user_id, gb_opt_out
        FROM {$db_prefix}garage_notifications_misc
        WHERE user_id = ".$memID,__FILE__,__LINE__);
    list($context['userID'],
         $context['gb_opt_out']) = mysql_fetch_row($request);
    mysql_free_result($request);
    
    // We need our functions!
    require_once('GarageFunctions.php');
    loadLanguage('Garage');
    
    // Load settings
    loadSmfgConfig();
    
    if($context['pm_opt_out'] == 1) $context['pm_opt_out_check'] = " checked=\"checked\"";
    if($context['email_opt_out'] == 1) $context['email_opt_out_check'] = " checked=\"checked\"";
    if($context['gb_opt_out'] == 1) $context['gb_opt_out_check'] = " checked=\"checked\"";
    
    if(!isset($context['pm_opt_out_check'])) $context['pm_opt_out_check'] = "";
    if(!isset($context['email_opt_out_check'])) $context['email_opt_out_check'] = "";
    if(!isset($context['gb_opt_out_check'])) $context['gb_opt_out_check'] = "";
    
]]></add>
        </operation>
        
        <operation>
            <search position="replace"><![CDATA[global $context, $memberContext, $txt, $modSettings, $user_info, $user_profile, $sourcedir, $db_prefix, $scripturl;]]></search>
            <add><![CDATA[global $context, $memberContext, $txt, $modSettings, $user_info, $user_profile, $sourcedir, $db_prefix, $scripturl, $smfgSettings;
    
    // We need a few garage things....
    require_once('GarageFunctions.php');
    //loadSmfgConfig();
    loadLanguage('Garage');]]></add>
        </operation>
        
        <operation>        
            <search position="before"><![CDATA['explanation' => $ban_explanation,
			);
		}
		mysql_free_result($request);
	}]]></search>
            <add><![CDATA[
            
    // Get vehicle data
    $request = db_query("
        SELECT v.id, CONCAT_WS(' ', v.made_year, mk.make, md.model)
        FROM {$db_prefix}garage_vehicles AS v, {$db_prefix}garage_makes AS mk, {$db_prefix}garage_models AS md
        WHERE v.user_id = ".$memID."
            AND v.make_id = mk.id
            AND v.model_id = md.id
            AND v.main_vehicle = 1
            AND v.pending != '1'
            AND mk.pending != '1'
            AND md.pending != '1'",__FILE__,__LINE__);
    list($context['member']['vid'],
         $context['member']['vehicle']) = mysql_fetch_row($request);
    mysql_free_result($request);
    
    // Get total vehicles
    $request = db_query("
        SELECT COUNT(id)
        FROM {$db_prefix}garage_vehicles
        WHERE user_id = ".$memID."
        GROUP BY user_id",__FILE__,__LINE__);
    list($context['member']['total_vehicles']) = mysql_fetch_row($request);
    mysql_free_result($request);
    
]]></add>
        </operation>
        
        <operation>
            <search position="before"><![CDATA[global $user_info, $txt, $ID_MEMBER, $modSettings;]]></search>
            <add><![CDATA[
    
    // We need garage talk...
    loadLanguage('Garage');]]></add>
        </operation>
      </file>
      
      <file name="$themedir/Profile.template.php">         
        <operation>
            <search position="before"><![CDATA[<div class="smalltext">', $txt[606], '</div><br />]]></search>
            <add><![CDATA[
            <div class="smalltext"><a href="'.$scripturl.'?action=garage;sa=get_gcard;u='.$_REQUEST['u'].'" rel="shadowbox;width=580;height=600" title="'.$txt['smfg_gcard_info'].'">'.$txt['smfg_get_gcard'].'</a></div>]]></add>
        </operation>
              
        <operation>
            <search position="before"><![CDATA[global $context, $settings, $options, $txt, $scripturl, $modSettings]]></search>
            <add><![CDATA[, $smfgSettings]]></add>
        </operation>
           
        <operation>
            <search position="before"><![CDATA[<label for="notifySendBody"><input type="checkbox" id="notifySendBody" name="notifySendBody"', !empty($context['member']['notify_send_body']) ? ' checked="checked"' : '', ' class="check" /> ', $txt['notify_send_body'], '</label><br />';]]></search>
            <add><![CDATA[
            
    // Garage notification options
    if(isset($context['memID'])) {
        if($smfgSettings['enable_pm_pending_notify_optout']) {
        echo '
                            <input type="hidden" name="pm_opt_out" value="0" />
                            <input type="checkbox" id="pm_opt_out" value="1" name="pm_opt_out"'.$context['pm_opt_out_check'].' class="check" /> ', $txt['smfg_pm_opt_out'], '<br />';
        }
        if($smfgSettings['enable_email_pending_notify_optout']) {
        echo '
                            <input type="hidden" name="email_opt_out" value="0" />
                            <input type="checkbox" id="email_opt_out" value="1" name="email_opt_out"'.$context['email_opt_out_check'].' class="check" /> ', $txt['smfg_email_opt_out'], '<br />';
        }
    }
        echo '
                            <input type="hidden" name="gb_opt_out" value="0" />
                            <input type="checkbox" id="gb_opt_out" value="1" name="gb_opt_out"'.$context['gb_opt_out_check'].' class="check" /> ', $txt['smfg_gb_opt_out'], '<br />';
]]></add>
        </operation>
           
        <operation>
            <search position="after"><![CDATA[// First do the containing table and table header.]]></search>
            <add><![CDATA[
    global $smfgSettings;
    
    ]]></add>
        </operation>
           
        <operation>
            <search position="before"><![CDATA[echo '
					</td>
				</tr><tr>
					<td colspan="2"><hr size="1" width="100%" class="hrcolor" /></td>
				</tr><tr>]]></search>
            <add><![CDATA[';

	// Do they have a vehicle?
    if($smfgSettings['integrate_profile'] && $context['member']['vehicle']) {

    echo '
                    <td><b>', $txt['smfg_vehicle'], ': </b>(1 '.$txt['smfg_of'].' '.$context['member']['total_vehicles'].')</td>
                    <td><a href="'.$scripturl.'?action=garage;sa=view_vehicle;VID='.$context['member']['vid'].'">', $context['member']['vehicle'], '</a></td>
                  </tr><tr>';
    }
	echo ']]></add>
        </operation>
    </file>
      
      <file name="$sourcedir/Display.php">        
        <operation>
            <search position="replace"><![CDATA[global $settings, $txt, $modSettings, $scripturl, $options, $user_info;]]></search>
            <add><![CDATA[global $settings, $txt, $modSettings, $scripturl, $options, $user_info, $smfgSettings;]]></add>
        </operation> 
            
        <operation>
            <search position="before"><![CDATA[global $memberContext, $context, $messages_request, $topic, $ID_MEMBER, $attachments;]]></search>
            <add><![CDATA[
    
    // A few garage items...
    require_once('GarageFunctions.php');
    loadSmfgConfig();
    loadLanguage('Garage');]]></add>
        </operation>
        
        <operation>
            <search position="replace"><![CDATA[// What?  It's not like it *couldn't* be only guests in this topic...
		if (!empty($posters))
			loadMemberData($posters);
		$messages_request = db_query("
			SELECT
				ID_MSG, icon, subject, posterTime, posterIP, ID_MEMBER, modifiedTime, modifiedName, body,
				smileysEnabled, posterName, posterEmail,
				ID_MSG_MODIFIED < $topicinfo[new_from] AS isRead
			FROM {$db_prefix}messages
			WHERE ID_MSG IN (" . implode(',', $messages) . ")
			ORDER BY ID_MSG" . (empty($options['view_newest_first']) ? '' : ' DESC'), __FILE__, __LINE__);]]></search>
            <add><![CDATA[// *************************************************************
        // WARNING: The query check is being disabled to allow for the following subselect.
        // It is imperative this is turned back on for security reasons.
        // *************************************************************
        $modSettings['disableQueryCheck'] = 1;
        // *************************************************************

		// What?  It's not like it *couldn't* be only guests in this topic...
        if (!empty($posters))
            loadMemberData($posters);
        $messages_request = db_query("
            SELECT
                m.ID_MSG, m.icon, m.subject, m.posterTime, m.posterIP, m.ID_MEMBER, m.modifiedTime, m.modifiedName, m.body,
                m.smileysEnabled, m.posterName, m.posterEmail,
                m.ID_MSG_MODIFIED < $topicinfo[new_from] AS isRead,
                uv.vehicle, uv.vid
            FROM {$db_prefix}messages AS m
            LEFT OUTER JOIN (
                    SELECT CONCAT_WS(' ', v.made_year, mk.make, md.model) AS vehicle, v.id AS vid, v.user_id
                    FROM {$db_prefix}garage_vehicles AS v, {$db_prefix}garage_makes AS mk, {$db_prefix}garage_models AS md
                    WHERE v.make_id = mk.id
                        AND v.model_id = md.id
                        AND v.main_vehicle = 1
                        AND mk.pending != '1'
                        AND md.pending != '1'
                        AND v.pending != '1'
                    ) AS uv ON uv.user_id = m.ID_MEMBER
            WHERE m.ID_MSG IN (" . implode(',', $messages) . ")
            ORDER BY m.ID_MSG" . (empty($options['view_newest_first']) ? '' : ' DESC'), __FILE__, __LINE__);
            
        // *************************************************************
        // WARNING: The query check is being enabled, this MUST BE DONE!
        // *************************************************************
        $modSettings['disableQueryCheck'] = 0;
        // *************************************************************]]></add>
        </operation>
        
        <operation>
            <search position="before"><![CDATA[$memberContext[$message['ID_MEMBER']]['ip'] = $message['posterIP'];]]></search>
            <add><![CDATA[
    $memberContext[$message['ID_MEMBER']]['vid'] = $message['vid'];
    $memberContext[$message['ID_MEMBER']]['vehicle'] = $message['vehicle'];]]></add>
        </operation>
    </file>
      
      <file name="$themedir/Display.template.php">        
        <operation>
            <search position="before"><![CDATA[global $context, $settings, $options, $txt, $scripturl, $modSettings]]></search>
            <add><![CDATA[, $smfgSettings]]></add>
        </operation>
                
        <operation>
            <search position="replace"><![CDATA[// Show how many posts they have made.
			echo '
								', $txt[26], ': ', $message['member']['posts'], '<br />
								<br />';]]></search>
            <add><![CDATA[// Show how many posts they have made.
            echo '
                                ', $txt[26], ': ', $message['member']['posts'], '<br />';
            
            if($smfgSettings['integrate_viewtopic'] && isset($message['member']['vehicle'])) {
            
                // Show their main vehicle.
                echo '
                                    ', $txt['smfg_vehicle'], ': <a href="'.$scripturl.'?action=garage;sa=view_vehicle;VID='.$message['member']['vid'].'">', $message['member']['vehicle'], '</a><br />
                                    <br />';
                                    
            }]]></add>
        </operation>
    </file>
      
      <file name="$languagedir/index.english.php">        
        <operation>
            <search position="end" />
            <add><![CDATA[
            
$txt['smfg_garage'] = 'Garage';

]]></add>
        </operation>
    </file>
      
      <file name="$languagedir/index.english-utf8.php" error="skip">
        <operation>
            <search position="end" />
            <add><![CDATA[
            
$txt['smfg_garage'] = 'Garage';

]]></add>
        </operation>
    </file>
      
      <file name="$languagedir/Admin.english.php">        
        <operation>
            <search position="end" />
            <add><![CDATA[
            
$txt['settings_general'] = 'This menu allows you to set your basic garage configuration options.';
$txt['settings_menu'] = 'This menu allows you to enable/disable the links available in the main garage menu.';
$txt['settings_index'] = 'This menu allows you to change the options and physical layout of the main garage page.';
$txt['settings_images'] = 'This menu allows you to set your garage image options.';
$txt['settings_videos'] = 'This menu allows you to set your garage video options.';
$txt['settings_modules'] = 'This menu allows you to enable/disable the various modules of SMF Garage and other related settings.';
$txt['management_business'] = 'This menu will allow you to enable/disable, edit, or delete businesses.';
$txt['management_categories'] = 'This menu will allow you to create, enable/disable, edit, or delete modification categories.';
$txt['management_makesmodels'] = 'This menu will allow you to create, enable/disable, edit, or delete makes and models.';
$txt['management_products'] = 'This menu will allow you to creat, enable/disable, edit, or delete modification products.';
$txt['management_tracks'] = 'This menu will allow you to create, enable/disable, edit, or delete tracks.  It also allows for management of track conditions and lap types.';
$txt['management_other'] = 'This menu will allow you to manage various other types in the garage.';
$txt['management_tools'] = 'Here you can use the provided utilities to optimize the database.  The database will first be checked and you will be presented with your options prior to modifying the database or files.';
$txt['management_pending'] = 'Any pending items will be shown here for you to approve, edit, or delete.  Any items that have been disabled will also show here until they are re-approved.';

]]></add>
        </operation>
    </file>
      
      <file name="$languagedir/Help.english.php">        
        <operation>
            <search position="end" />
            <add><![CDATA[
            
$helptxt['year_range'] = 'This is the earliest year you want to appear as a selection for a new vehicle. Format CCYY.';
$helptxt['year_offset'] = 'Amount of years offset from current year for latest year you want to appear for a new vehicle.';
$helptxt['vehicle_quota'] = 'This is the max limit of vehicles per user.  This can be overridden by assigning \'Exempt from Limits\' permissions.';
$helptxt['vehicles_per_page'] = 'This controls the number of vehicles that will be displayed per page under the various menu items; Browse, Quartermiles, Dynoruns, and Laptimes.';
$helptxt['user_make_submission'] = 'Will allow for users to submit makes to the database which do not already exist.';
$helptxt['user_model_submission'] = 'Will allow for users to submit models to the database which do not already exist.';
$helptxt['user_business_submission'] = 'Will allow for users to submit businesses to the database which do not already exist.';
$helptxt['user_product_submission'] = 'Will allow for users to submit modification products to the database which do not already exist.';
$helptxt['pending_pm'] = 'Enable pending PM notifications on submitted items which require approval.';
$helptxt['pm_opt_out'] = 'Allow users on the pending notification list to opt out of PM notifications.';
$helptxt['pending_email'] = 'Enable pending email notifications on submitted items which require approval.';
$helptxt['email_opt_out'] = 'Allow users on the pending notification list to opt out of email notifications.';
$helptxt['pending_subject'] = 'Subject for pending PM and email notifications.';
$helptxt['pending_sender_id'] = 'ID of the user in which PMs will be sent from.';
$helptxt['integrate_viewtopic'] = 'Show user\'s main vehicle with profile information in posts.';
$helptxt['integrate_profile'] = 'Show user\'s main vehicle information in their user profile.';
$helptxt['rating_system'] = 'Select which type of rating you would like to use.  Cumulative will total all votes together (ie. 91/100) and Average will average all the votes (ie. 9.1/10).';
$helptxt['members_notify'] = 'All users on this list will receive PM and email notifications on all pending items which require approval.  These users will have additional options in their profile settings to opt out of PM and email notifications.';
$helptxt['featured_vehicle'] = 'You may disable the featured vehicle or select which method to identify a featured vehicle by.  You may specify a vehicle ID, choose a block which will show its top vehicle, or select a random vehicle on each refresh.';
$helptxt['featured_vehicle_image_required'] = 'This option ensures an image is displayed on the Featured Vehicle block. The \'Random\' option will only display vehicles with images attached to them. \'From vehicle ID\' and \'From block\' options will display a \'No Image\' place holder for vehicle with no images attached to them.';
$helptxt['featured_vehicle_id'] = 'If featured vehicle is set to \'From vehicle ID\', use the ID of the vehicle you want to feature.';
$helptxt['featured_vehicle_block'] = 'If featured vehicle is set to \'From block\', choose a block to determine the vehicle to feature.';
$helptxt['featured_vehicle_description'] = 'You may choose to add a description below the featured vehicle.  Leave this blank to disable.';
$helptxt['columns_index'] = 'You may choose to show all the enabled blocks on the front page with one or two columns.';
$helptxt['black_management'] = 'Here you can enable/disable, re-order, and set the limits for each of the blocks on the main garage page.';
$helptxt['store_remote_locally'] = 'You can choose to either store remote images locally or link to their remote locations.  All images will be thumbnailed and thumbnails will always be stored locally.<br /><br />This setting is not retroactive, for example, if you choose to store remote images locally and then choose to not store them locally then all previously stored images will remain stored locally unless you delete and re-upload the image.';
$helptxt['enable_lightbox'] = 'Lightbox is the effects module for displaying images.';
$helptxt['gallery_limit'] = 'The max number of images allowed in each gallery.  Each vehicle, modification, quartermile, dynorun, and laptime is considered its own gallery.';
$helptxt['gallery_limit_video'] = 'The max number of videos allowed in each gallery.  Each vehicle, modification, quartermile, dynorun, and laptime is considered its own gallery.';
$helptxt['upload_directory'] = 'This is the directory where images and thumbnails will be stored.  The path is relative to your forum root and should not use a starting forward slash, and must have an ending forward slash.<br /><br /><b>Default:</b> \'<i>Garage/uploads/\'</i>';
$helptxt['watermark_source'] = 'This is the path to the image you would like to use as a watermark.  The path is relative to your forum root and should not use a starting forward slash.<br /><br /><b>Default:</b> \'<i>Themes/default/images/watermark.png\'</i>';
$helptxt['IM_convert'] = 'SMF Garage utilizes ImageMagick for watermarks and thumbnails, provide the path to the ImageMagick \'convert\' directory.  The path is relative to your forum root and must use a starting forward slash, and should not have an ending forward slash.<br /><br /><b>Default:</b> \'<i>/usr/bin/convert\'</i>';
$helptxt['IM_composite'] = 'SMF Garage utilizes ImageMagick for watermarks and thumbnails, provide the path to the ImageMagick \'composite\' directory.  The path is relative to your forum root and must use a starting forward slash, and should not have an ending forward slash.<br /><br /><b>Default:</b> \'<i>/usr/bin/composite\'</i>';
$helptxt['create_model'] = 'First select a make, then enter the model you would like to create.';
$helptxt['create_product'] = 'First select a manufacturer, then enter the product you would like to create.';
$helptxt['garage_settings'] = '
    <ul>
        <li>
            <b>General</b><br />
            Modify general settings for the garage.  Year ranges, vehicle quotas, date format, pagination options, user submission and approvals, and notification options for pending items.
        </li><li>
            <b>Menu</b><br />
            Configure the main garage menu tabs.
        </li><li>
            <b>Index Page</b>
            Modify the look and layout of the main garage page.  Featured vehicle options.  Also allows for enable/disable, re-order, or set the limits for the number of vehicles to display per block.
        </li><li>
            <b>Images</b>
            Modify image settings, enable/display galleries for each module, remote image handling, set filesize options, upload directory, watermark configuration, and ImageMagick directories.
        </li><li>
            <b>Modules</b>
            Enable/disable the various garage modules and set pertinent options for each module.
        </li>
    </ul>';
$helptxt['garage_management'] = '
    <ul>
        <li>
            <b>Businesses</b><br />
            Approve, enable/disable, edit, or delete businesses.
        </li><li>
            <b>Categories</b><br />
            Re-order, edit, or delete modification categories.
        </li><li>
            <b>Makes/Models</b>
            Approve, enable/disable, edit, or delete makes or models.
        </li><li>
            <b>Products</b>
            Approve, enable/disable, edit, or delete modification products.
        </li><li>
            <b>Tracks</b>
            Approve, enable/disable, edit or delete tracks.  Also allows to re-order, edit, or delete track conditions and lap types.
        </li><li>
            <b>Other</b>
            Allows to re-order, edit, or delete; premium types, engine types, service types, and currency types.
        </li><li>
            <b>Tools</b>
            Utilities to help optimize the database.  This utility will find any existing files not listed in the database, and vice-versa, find any database entries missing files and remove them from the database if you approve the action after it returns the results to you.
        </li><li>
            <b>Pending</b>
            Any pending or disabled items will display here.  Only items which require approval can be pending, but by disabling an item it will also show in this list until it is re-approved.
        </li>
    </ul>';
    
]]></add>
        </operation>
    </file>
      
      <file name="$languagedir/Errors.english.php">        
        <operation>
            <search position="end" />
            <add><![CDATA[
            
$txt['cannot_view_garage'] = 'You can\'t view the garage because you don\'t have permission to.';
$txt['cannot_browse_vehicles'] = 'You are not allowed to browse vehicles.';
$txt['cannot_view_vehicles'] = 'You cannot view vehicles based on your permissions.';
$txt['cannot_own_vehicle'] = 'You cannot create a vehicle based on your permissions.';
$txt['cannot_search_vehicles'] = 'You are not allowed to search vehicles.';
$txt['cannot_browse_insurance'] = 'You are not allowed to browse insurance companies.';
$txt['cannot_view_insurance'] = 'You can\'t view insurance based on your permissions.';
$txt['cannot_browse_shops'] = 'You are not allowed to browse shops.';
$txt['cannot_view_shops'] = 'You can\'t view shops based on your permissions.';
$txt['cannot_browse_garages'] = 'You are not allowed to browse garages.';
$txt['cannot_view_garages'] = 'You can\'t view garages based on your permissions.';
$txt['cannot_browse_qms'] = 'You are not allowed to browse quartermile runs.';
$txt['cannot_view_qms'] = 'You can\'t view quartermile runs based on your permissions.';
$txt['cannot_browse_dynos'] = 'You are not allowed to browse dyno runs.';
$txt['cannot_view_dynos'] = 'You can\'t view dyno runs based on your permissions.';
$txt['cannot_browse_laps'] = 'You are not allowed to browse lap times.';
$txt['cannot_view_laps'] = 'You can\'t view lap times based on your permissions.';
$txt['cannot_post_comments'] = 'You are not allowed to post comments in the garage.';

$txt['cannot_manage_garage_settings'] = 'You are not allowed to manage the garage settings.';
$txt['cannot_manage_garage_general'] = 'You are not allowed to manage the garage\'s general settings.';
$txt['cannot_manage_garage_menu'] = 'You are not allowed to manage the garage menu.';
$txt['cannot_manage_garage_index'] = 'You are not allowed to manage the garage index page.';
$txt['cannot_manage_garage_images'] = 'You are not allowed to manage image settings.';
$txt['cannot_manage_garage_modules'] = 'You are not allowed to manage module settings.';
$txt['cannot_manage_garage_quotas'] = 'You are not allowed to manage quota settings.';
$txt['cannot_manage_garage'] = 'You are not allowed to manage garage content.';
$txt['cannot_manage_garage_businesses'] = 'You are not allowed to manage businesses.';
$txt['cannot_manage_garage_categories'] = 'You are not allowed to manage modification categories.';
$txt['cannot_manage_garage_makes_models'] = 'You are not allowed to manage makes/models.';
$txt['cannot_manage_garage_products'] = 'You are not allowed to manage products.';
$txt['cannot_manage_garage_tools'] = 'You are not allowed to use garage tools.';
$txt['cannot_manage_garage_tracks'] = 'You are not allowed to manage tracks.';
$txt['cannot_manage_garage_other'] = 'You are not allowed to manage these settings.';

$txt['garage_filesize_error'] = 'The file you are attempting to upload exceeds the maximum filesize of '.$smfgSettings['max_image_kbytes'].' kilobytes.  Please click back and select a file that meets the filesize restrictions.';
$txt['garage_resolution_error'] = 'The image you are attempting to upload exceeds the maximum file resolution of '.$smfgSettings['max_image_resolution'].'x'.$smfgSettings['max_image_resolution'].'.  Please click back and select an image that meets the resolution restrictions or resize the image to meet them.';
$txt['garage_no_image_supplied'] = 'You did not select an image, please go back and select an image before submitting.';
$txt['garage_video_unsupported'] = 'The video you are attempting to upload is not a supported video site.  Please use a video sharing site listed on the supported sites list.';
$txt['garage_video_title_required'] = 'You have submitted a video with no title, a title is required if you wish to submit a video.';
$txt['garage_rating_error2'] = 'You are not allowed to rate your own vehicle.';
$txt['garage_owner_error'] = 'This vehicle does not belong to you, quit trying to edit other people\'s vehicles.';
$txt['garage_edit_comment_error'] = 'You cannot edit other user\'s comments.';
$txt['garage_rating_error'] = 'You cannot remove other user\'s ratings.';
$txt['garage_double_rating_error'] = 'You cannot rate the same vehicle more than once.';
$txt['garage_gallery_limit_error'] = 'This gallery already has the maximum number of images allowed.  Before adding more images you must delete one or more existing images.';
$txt['garage_gallery_limit_video_error'] = 'This gallery already has the maximum number of videos allowed.  Before adding more videos you must delete one or more existing videos';
$txt['garage_vehicle_limit_error'] = 'Your garage has already reached the maximum number of vehicles allowed.  Before adding more vehicles you must delete one or more existing vehicles.';
$txt['garage_submit_make_error'] = 'The make you are trying to submit already exists, there is no need to re-submit the make.  To use the desired make, go back and select it from the \'Make\' drop down.';
$txt['garage_submit_model_error'] = 'The model you are trying to submit already exists, there is no need to re-submit the model.  To use the desired model, go back and select the appropriate make from the \'Make\' drop down, the select the model from the \'Model\' drop down.';
$txt['garage_submit_business_error'] = 'The business you are trying to submit already exists, there is no need to re-submit the business.  To use the desired business, go back and select it from the \'Business\' drop down.';
$txt['garage_submit_product_error'] = 'The product you are trying to submit already exists, there is no need to re-submit the product.  To use the desired product, go back and select it from the \'Product\' drop down.';
$txt['garage_submit_track_error'] = 'The track you are trying to submit already exists, there is no need to re-submit the track.  To use the desired track, go back and select it from the \'Track\' drop down.';
$txt['garage_required_image_error'] = 'The administrator has chosen to require an image with this submission.  Please go back and select an image to submit.';
$txt['garage_disabled_module_error'] = 'This module is disabled.  Please contact the administrator if you feel this is an error.';
$txt['garage_nonexistent_member_error'] = 'The member name you supplied does not match any current members.  Please go back and try again.';
$txt['garage_pending_vehicle_error'] = 'The vehicle you are attempting to view is currently pending, unless you are the vehicle owner or have permission to view pending items, you cannot view this vehicle at this time.';
$txt['garage_pending_item_error'] = 'The item you are attempting to view is currently pending, unless you have permission to view pending items you cannot view this item at this time.';
$txt['garage_disabled_error'] = 'The garage has been disabled at this time for maintenance.  Please check back later or contact the administrator if you feel this is an error.';
$txt['garage_no_search_criteria'] = 'You must select criteria to search for.  Make sure you check the box next to the criteria you would like to search.';
$txt['garage_no_direct_page_access'] = 'Sorry this page can not be access directly.';
$txt['garage_no_vehicle'] = 'Vehicle does not exist.';
$txt['garage_no_modification'] = 'Modification does not exist.';
$txt['garage_no_quartermile'] = 'Quartermile does not exist.';
$txt['garage_no_dynorun'] = 'Dynorun does not exist.';
$txt['garage_no_laptime'] = 'Laptime does not exist.';
$txt['garage_no_track'] = 'Track does not exist.';

]]></add>
        </operation>
             
        <operation>
            <search position="after"><![CDATA[$txt[1] = 'You are not allowed to access this section';]]></search>
            <add><![CDATA[
global $smfgSettings;

]]></add>
        </operation>
    </file>
      
      <file name="$languagedir/Who.english.php">        
        <operation>
            <search position="end" />
            <add><![CDATA[
            
$txt['whoall_garage'] = 'Viewing the <a href="' . $scripturl . '?action=garage">Garage</a>.';
$txt['whoall_garage_user_garage'] = 'Viewing own <a href="' . $scripturl . '?action=garage">garage</a>.';
$txt['whoall_garage_view_own_vehicle'] = 'Viewing own <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d">vehicle</a>.';
$txt['whoall_garage_edit_vehicle'] = 'Editing the vehicle <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d">%s<a/>.';
$txt['whoall_garage_edit_modification'] = 'Editing the modification <a href="' . $scripturl . '?action=garage;sa=view_modification;VID=%d;MID=%d">%s<a/>.';
$txt['whoall_garage_edit_quartermile'] = 'Editing the quartermile <a href="' . $scripturl . '?action=garage;sa=view_quartermile;VID=%d;QID=%d">%s<a/>.';
$txt['whoall_garage_edit_dynorun'] = 'Editing the dynorun <a href="' . $scripturl . '?action=garage;sa=view_dynorun;VID=%d;DID=%d">%s<a/>.';
$txt['whoall_garage_edit_laptime'] = 'Editing the laptime <a href="' . $scripturl . '?action=garage;sa=view_laptime;VID=%d;LID=%d">%s<a/>.';
$txt['whoall_garage_edit_insurance'] = 'Editing a premium for <a href="' . $scripturl . '?action=garage;sa=view_insurance;VID=%d#premiums">%s<a/>.';
$txt['whoall_garage_edit_service'] = 'Editing a service for <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d#services">%s<a/>.';
$txt['whoall_garage_edit_blog'] = 'Editing a blog post for <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d#blog">%s<a/>.';
$txt['whoall_garage_edit_comment'] = 'Editing a guestbook comment for <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d#guestbook">%s<a/>.';
$txt['whoall_garage_view_vehicle'] = 'Viewing the vehicle <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d">%s<a/>.';
$txt['whoall_garage_browse'] = 'Browsing <a href="' . $scripturl . '?action=garage;sa=browse">Garage</a>.';
$txt['whoall_garage_search'] = 'Searching <a href="' . $scripturl . '?action=garage;sa=search">Garage</a>.';
$txt['whoall_garage_search_results'] = 'Viewing <a href="' . $scripturl . '?action=garage">Garage</a> Search Results.';
$txt['whoall_garage_insurance'] = 'Browsing <a href="' . $scripturl . '?action=garage;sa=insurance">Insurance Reviews</a>.';
$txt['whoall_garage_insurance_review'] = 'Viewing insurance review for <a href="' . $scripturl . '?action=garage;sa=insurance_review;BID=%d">%s<a/>.';
$txt['whoall_garage_shops'] = 'Browsing <a href="' . $scripturl . '?action=garage;sa=shops">Shop Reviews</a>.';
$txt['whoall_garage_shop_review'] = 'Viewing shop reviews for <a href="' . $scripturl . '?action=garage;sa=shop_review;BID=%d">%s<a/>.';
$txt['whoall_garage_garages'] = 'Browsing <a href="' . $scripturl . '?action=garage;sa=garages">Garage Reviews</a>.';
$txt['whoall_garage_garage_review'] = 'Viewing garage reviews for <a href="' . $scripturl . '?action=garage;sa=garage_review;BID=%d">%s<a/>.';
$txt['whoall_garage_quartermiles'] = 'Browsing <a href="' . $scripturl . '?action=garage;sa=quartermiles">Quartermiles</a>.';
$txt['whoall_garage_view_quartermile'] = 'Viewing the quartermile <a href="' . $scripturl . '?action=garage;sa=view_quartermile;VID=%d;QID=%d">%s<a/>.';
$txt['whoall_garage_dynoruns'] = 'Browsing <a href="' . $scripturl . '?action=garage;sa=dynoruns">Dynoruns</a>.';
$txt['whoall_garage_view_dynorun'] = 'Viewing the dynorun <a href="' . $scripturl . '?action=garage;sa=view_dynorun;VID=%d;DID=%d">%s<a/>.';
$txt['whoall_garage_laptimes'] = 'Browsing <a href="' . $scripturl . '?action=garage;sa=laptimes">Laptimes</a>.';
$txt['whoall_garage_view_laptime'] = 'Viewing the laptime <a href="' . $scripturl . '?action=garage;sa=view_laptime;VID=%d;LID=%d">%s<a/>.';
$txt['whoall_garage_view_modification'] = 'Viewing the modification <a href="' . $scripturl . '?action=garage;sa=view_modification;VID=%d;MID=%d">%s<a/>.';
$txt['whoall_garagesettings'] = 'Changing garage settings.';
$txt['whoall_garagemanagement'] = 'Managing garage content.';
$txt['whoall_garage_unknown'] = 'Playing around some place in the <a href="' . $scripturl . '?action=garage">Garage</a>.';
$txt['whoall_garage_add_service'] = 'Adding a new service to <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d">%s<a/>.';
$txt['whoall_garage_add_laptime'] = 'Adding a new laptime to <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d">%s<a/>.';
$txt['whoall_garage_add_dynorun'] = 'Adding a new dynorun to <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d">%s<a/>.';
$txt['whoall_garage_add_quartermile'] = 'Adding a new quartermile to <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d">%s<a/>.';
$txt['whoall_garage_add_insurance'] = 'Adding a new premium to <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d">%s<a/>.';
$txt['whoall_garage_add_modification'] = 'Adding a new modification to <a href="' . $scripturl . '?action=garage;sa=view_vehicle;VID=%d">%s<a/>.';

]]></add>
        </operation>
    </file>
      
      <file name="$sourcedir/Who.php">        
        <operation>
            <search position="before"><![CDATA[$board_ids = array();]]></search>
            <add><![CDATA[
	$garage_ids = array();]]></add>
        </operation>

        <operation>
            <search position="after"><![CDATA[// A subaction anyone can view... if the language string is there, show it.]]></search>
            <add><![CDATA[elseif ($actions['action'] == 'garage' && !empty($actions['sa']))
                        {
                                $data[$k] = $txt['who_hidden'];
                                if (!empty($actions['MID']) && !empty($actions['VID']))
                                        $garage_ids['MID'][(int) $actions['MID']][$k] = $txt['whoall_' . $actions['action'] . '_' . $actions['sa']];
                                else if (!empty($actions['DID']) && !empty($actions['VID']))
                                        $garage_ids['DID'][(int) $actions['DID']][$k] = $txt['whoall_' . $actions['action'] . '_' . $actions['sa']];
                                else if (!empty($actions['LID']) && !empty($actions['VID']))
                                        $garage_ids['LID'][(int) $actions['LID']][$k] = $txt['whoall_' . $actions['action'] . '_' . $actions['sa']];
                                else if (!empty($actions['QID']) && !empty($actions['VID']))
                                        $garage_ids['QID'][(int) $actions['QID']][$k] = $txt['whoall_' . $actions['action'] . '_' . $actions['sa']];
                                else if (!empty($actions['BID']) && !empty($actions['VID']))
                                        $garage_ids['VID'][(int) $actions['VID']][$k] = $txt['whoall_' . $actions['action'] . '_' . $actions['sa']];
                                else if (!empty($actions['INS_ID']) && !empty($actions['VID']))
                                        $garage_ids['VID'][(int) $actions['VID']][$k] = $txt['whoall_' . $actions['action'] . '_' . $actions['sa']];
                                else if (!empty($actions['SID']) && !empty($actions['VID']))
                                        $garage_ids['VID'][(int) $actions['VID']][$k] = $txt['whoall_' . $actions['action'] . '_' . $actions['sa']];
                                else if (!empty($actions['CID']) && !empty($actions['VID']))
                                        $garage_ids['VID'][(int) $actions['VID']][$k] = $txt['whoall_' . $actions['action'] . '_' . $actions['sa']];
                                else if (!empty($actions['BID']) && empty($actions['VID']))
                                        $garage_ids['BID'][(int) $actions['BID']][$k] = $txt['whoall_' . $actions['action'] . '_' . $actions['sa']];
                                else if (!empty($actions['VID']))
                                        $garage_ids['VID'][(int) $actions['VID']][$k] = $txt['whoall_' . $actions['action'] . '_' . $actions['sa']];
				else
                                        $data[$k] = $txt['whoall_garage_unknown'];
                        }
                        elseif ($actions['action'] == 'garagemanagement' || $actions['action'] == 'garagesettings')
                        {
                                $data[$k] = $txt['whoall_' . $actions['action']];
                        }
			]]></add>
        </operation>

        <operation>
            <search position="after"><![CDATA[// Load member names for the profile.]]></search>
            <add><![CDATA[// Load garage info.
        if (!empty($garage_ids))
        {
		foreach ($garage_ids as $type => $ids)
		{
			if (!empty($ids))
			{
				$ints = 1;
				switch ($type)
				{
                                        // vehicles
					case 'VID':
						$query = "SELECT v.id AS id, CONCAT_WS( ' ', v.made_year, mk.make, md.model) AS description FROM {$db_prefix}garage_vehicles AS v, {$db_prefix}garage_makes AS mk, {$db_prefix}garage_models AS md WHERE v.id IN (" . implode(', ', array_keys($ids)) .") AND v.make_id = mk.id AND v.model_id = md.id LIMIT " . count($ids);
						break;
                                        // mods
					case 'MID':
						$query = "SELECT m.vehicle_id AS vid, m.id AS id, p.title AS description FROM {$db_prefix}garage_products AS p, {$db_prefix}garage_modifications AS m WHERE m.id IN (" . implode(', ', array_keys($ids)) . ") AND m.product_id = p.id LIMIT " . count($ids);
						$ints = 2;
						break;
                                        // laptimes
					case 'LID':
						$query = "SELECT l.vehicle_id AS vid, l.id AS id, t.title AS description FROM {$db_prefix}garage_laps AS l, {$db_prefix}garage_tracks AS t WHERE l.id IN (" . implode(', ', array_keys($ids)) . ") AND t.id = l.track_id LIMIT " . count($ids);
						$ints = 2;
						break;
                                        // dynoruns
					case 'DID':
						$query = "SELECT d.vehicle_id AS vid, d.id AS id, CONCAT_WS( ' ', d.bhp, d.bhp_unit, '/', d.torque, d.torque_unit, '/', d.nitrous) AS description FROM {$db_prefix}garage_dynoruns AS d WHERE d.id IN (" . implode(', ', array_keys($ids)) . ") LIMIT " . count($ids);
						$ints = 2;
						break;
                                        // quartermiles
					case 'QID':
						$query = "SELECT q.vehicle_id AS vid, q.id AS id, CONCAT_WS( ' ', q.quart, q.quartmph) AS description FROM {$db_prefix}garage_quartermiles AS q WHERE q.id IN (" . implode(', ', array_keys($ids)) . ") LIMIT " . count($ids);
						$ints = 2;
						break;
                                        // businesses
					case 'BID':
						$query = "SELECT b.id AS id, b.title AS description FROM {$db_prefix}garage_business AS b WHERE b.id IN (" . implode(', ', array_keys($ids)) . ") LIMIT " . count($ids);
						break;
				}

				$result = db_query($query, __FILE__, __LINE__);
                		while ($row = mysql_fetch_assoc($result))
                		{
                        		// Put the names and ids into the string...
                        		foreach ($ids[$row['id']] as $k => $session_text)
                                		if ($ints == 2)
                                			$data[$k] = sprintf($session_text, $row['vid'], $row['id'], $row['description']);
                                		else
                                			$data[$k] = sprintf($session_text, $row['id'], $row['description']);
                		}
                		mysql_free_result($result);
			}
		}
        }

	]]></add>
        </operation>
    </file>

      <file name="$languagedir/ManagePermissions.english.php">        
        <operation>
            <search position="end" />
            <add><![CDATA[
            
$txt['permissiongroup_garage'] = 'Garage';
$txt['permissionname_view_garage'] = 'View Garage';
$txt['permissionhelp_view_garage'] = 'This permission allows a user to view the garage.';
$txt['permissionname_browse_vehicles'] = 'Browse Vehicles';
$txt['permissionhelp_browse_vehicles'] = 'This permission allows a user to browse vehicles.';
$txt['permissionname_view_vehicles'] = 'View Vehicles';
$txt['permissionhelp_view_vehicles'] = 'This permission allows a user to view vehicle profiles.';
$txt['permissionname_own_vehicle'] = 'Create Vehicle';
$txt['permissionhelp_own_vehicle'] = 'This permission allows a user to create a vehicle.';
$txt['permissionname_search_vehicles'] = 'Search Vehicles';
$txt['permissionhelp_search_vehicles'] = 'This permission allows a user to search vehicles in the garage.';
$txt['permissionname_browse_insurance'] = 'Browse Insurance';
$txt['permissionhelp_browse_insurance'] = 'This permission allows a user to browse insurance companies.';
$txt['permissionname_view_insurance'] = 'View Insurance';
$txt['permissionhelp_view_insurance'] = 'This permission allows a user to view insurance company profiles.';
$txt['permissionname_browse_shops'] = 'Browse Shops';
$txt['permissionhelp_browse_shops'] = 'This permission allows a user to browse shops in the garage.';
$txt['permissionname_view_shops'] = 'View Shops';
$txt['permissionhelp_view_shops'] = 'This permission allows a user to view shop profiles.';
$txt['permissionname_browse_garages'] = 'Browse Garages';
$txt['permissionhelp_browse_garages'] = 'This permission allows a user to browse garages in the garage.';
$txt['permissionname_view_garages'] = 'View Garages';
$txt['permissionhelp_view_garages'] = 'This permission allows a user to view garage profiles.';
$txt['permissionname_browse_qms'] = 'Browse Quartermiles';
$txt['permissionhelp_browse_qms'] = 'This permission allows a user to browse quartermiles in the garage.';
$txt['permissionname_view_qms'] = 'View Quartermile Runs';
$txt['permissionhelp_view_qms'] = 'This permission allows a user to view quartermile runs.';
$txt['permissionname_browse_dynos'] = 'Browse Dyno Runs';
$txt['permissionname_view_dynos'] = 'View Dyno Runs';
$txt['permissionhelp_view_dynos'] = 'This permission allows a user to view dyno runs.';
$txt['permissionhelp_browse_dynos'] = 'This permission allows a user to browse dyno runs in the garage.';
$txt['permissionname_browse_laps'] = 'Browse Lap Times';
$txt['permissionhelp_browse_laps'] = 'This permission allows a user to browse lap times in the garage.';
$txt['permissionname_view_laps'] = 'View Lap Times';
$txt['permissionhelp_view_laps'] = 'This permission allows a user to view lap times.';
$txt['permissionname_post_comments'] = 'Post Comments';
$txt['permissionhelp_post_comments'] = 'This permission allows a user to post comments in other users guestbooks.';

$txt['permissiongroup_garage_acp'] = 'Garage administration';
$txt['permissionname_manage_garage_settings'] = 'Manage Garage Settings';
$txt['permissionhelp_manage_garage_settings'] = 'This permission allows a user to manage the garage\'s settings.  In order for a user to edit any garage settings they must first be granted this permission.';
$txt['permissionname_manage_garage_general'] = 'Edit General Settings';
$txt['permissionhelp_manage_garage_general'] = 'This permission allows a user to manage the garage\'s general configuration settings.';
$txt['permissionname_manage_garage_menu'] = 'Edit Menu Settings';
$txt['permissionhelp_manage_garage_menu'] = 'This permission allows a user to manage the garage\'s menu by enabling/disabling menu options.';
$txt['permissionname_manage_garage_index'] = 'Edit Index Settings';
$txt['permissionhelp_manage_garage_index'] = 'This permissions allows a user to configure the front page index:<ul><li>Number of columns</li><li>Enable featured vehicle</li><li>Enable/Disable front page display blocks</li><li>Set front page display block limits</li></ul>';
$txt['permissionname_manage_garage_images'] = 'Edit Image Settings';
$txt['permissionhelp_manage_garage_images'] = 'This permission allows a user to manage garage image settings.';
$txt['permissionname_manage_garage_videos'] = 'Edit Video Settings';
$txt['permissionhelp_manage_garage_videos'] = 'This permission allows a user to manage garage video settings.';
$txt['permissionname_manage_garage_modules'] = 'Edit Module Settings';
$txt['permissionhelp_manage_garage_modules'] = 'This permission allows a user to manage garage module settings.';
$txt['permissionname_manage_garage'] = 'Manage Garage Contents';
$txt['permissionhelp_manage_garage'] = 'This permission allows a user to manage the garage\'s content such as businesses, modification categories, tracks, and vehicle data types.  In order for a user to manage any garage content they must first be granted this permission.';
$txt['permissionname_manage_garage_businesses'] = 'Manage Businesses';
$txt['permissionhelp_manage_garage_businesses'] = 'This permissions allows a user to add/edit/delete existing businesses.';
$txt['permissionname_manage_garage_categories'] = 'Manage Categories';
$txt['permissionhelp_manage_garage_categories'] = 'This permissions allows a user to add/edit/delete existing modification categories.';
$txt['permissionname_manage_garage_makes_models'] = 'Manage Makes/Models';
$txt['permissionhelp_manage_garage_makes_models'] = 'This permissions allows a user to add/edit/delete existing makes/models.';
$txt['permissionname_manage_garage_products'] = 'Manage Products';
$txt['permissionhelp_manage_garage_products'] = 'This permissions allows a user to add/edit/delete existing modification products.';
$txt['permissionname_manage_garage_tools'] = 'Manage Tools';
$txt['permissionhelp_manage_garage_tools'] = 'This permission allows a user to run garage tools/utilities.';
$txt['permissionname_manage_garage_tracks'] = 'Manage Tracks';
$txt['permissionhelp_manage_garage_tracks'] = 'This permissions allows a user to add/edit/delete existing tracks.';
$txt['permissionname_manage_garage_other'] = 'Manage Other';
$txt['permissionhelp_manage_garage_other'] = 'This permissions allows a user to manage the contents of the \'other\' tab.';
$txt['permissionname_manage_garage_pending'] = 'Manage Pending Items';
$txt['permissionhelp_manage_garage_pending'] = 'This permissions allows a user to manage pending items in the garage.';
$txt['permissionname_edit_all_vehicles'] = 'Edit Any Vehicle';
$txt['permissionhelp_edit_all_vehicles'] = 'This permissions allows a user to edit other user\'s vehicles in the garage.';
$txt['permissionname_edit_all_comments'] = 'Edit Any Comment';
$txt['permissionhelp_edit_all_comments'] = 'This permissions allows a user to edit other user\'s comments in the guestbooks.';
$txt['permissionname_limit_exemption'] = 'Exempt from Limits';
$txt['permissionhelp_limit_exemption'] = 'This permissions allows a user to be exempt from gallery or vehicle limits.';

]]></add>
        </operation>
    </file>
    
    <file name="$themedir/style.css">
        <operation>
            <search position="before"><![CDATA[.windowbg3
{
	color: #000000;
	background-color: #E0E1E8;
}]]></search>
            <add><![CDATA[
.windowbg_pending
{
	color: #000000;
	background-color: #EEB4B4;
}
]]></add>
        </operation>
    </file>  
    
</modification>
